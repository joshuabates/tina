[tools]
node = "22"

# --- Services (Overmind) ---

[tasks.dev]
description = "Start all dev services via Overmind"
run = "overmind start -f Procfile"

[tasks."dev:web"]
description = "Start frontend dev server only (defaults to prod Convex profile)"
run = """
set -e
TINA_ENV="${TINA_ENV:-prod}"
CONVEX_URL=$(cargo run --quiet --manifest-path tina-session/Cargo.toml -- config convex-url --env "$TINA_ENV")
cd tina-web
VITE_TINA_ENV="$TINA_ENV" VITE_CONVEX_URL="$CONVEX_URL" npm run dev
"""

[tasks."dev:web:dev"]
description = "Start frontend dev server against dev Convex profile"
run = "TINA_ENV=dev mise run dev:web"

[tasks."dev:storybook"]
description = "Start Storybook dev server"
run = "cd tina-web && npm run storybook"

[tasks."dev:convex"]
description = "Start Convex dev server only"
run = "npx convex dev"

[tasks."dev:daemon"]
description = "Start tina-daemon only"
run = "cargo run --manifest-path tina-daemon/Cargo.toml -- --env ${TINA_ENV:-prod}"

[tasks."dev:connect"]
description = "Connect to a running Overmind service"
run = "overmind connect {{arg(name=\"service\")}}"

[tasks."dev:restart"]
description = "Restart an Overmind service"
run = "overmind restart {{arg(name=\"service\")}}"

[tasks."dev:stop"]
description = "Stop all Overmind services"
run = "overmind stop"

# --- Build ---

[tasks.build]
description = "Build all crates (release)"
run = """
set -e
echo "Building tina-session..."
cargo build --release --manifest-path tina-session/Cargo.toml
echo "Building tina-daemon..."
cargo build --release --manifest-path tina-daemon/Cargo.toml
echo "Building tina-monitor..."
cargo build --release --manifest-path tina-monitor/Cargo.toml
echo "Building tina-harness..."
cargo build --release --manifest-path tina-harness/Cargo.toml
"""

[tasks."build:frontend"]
description = "Build frontend (defaults to prod Convex profile)"
run = """
set -e
TINA_ENV="${TINA_ENV:-prod}"
CONVEX_URL=$(cargo run --quiet --manifest-path tina-session/Cargo.toml -- config convex-url --env "$TINA_ENV")
cd tina-web
VITE_TINA_ENV="$TINA_ENV" VITE_CONVEX_URL="$CONVEX_URL" npm run build
"""

# --- Install ---

[tasks.install]
description = "Build CLIs and symlink to ~/.local/bin"
depends = ["build"]
run = """
set -e
BIN_DIR="$HOME/.local/bin"
mkdir -p "$BIN_DIR"
ln -sf "$MISE_PROJECT_ROOT/tina-session/target/release/tina-session" "$BIN_DIR/tina-session"
ln -sf "$MISE_PROJECT_ROOT/tina-monitor/target/release/tina-monitor" "$BIN_DIR/tina-monitor"
ln -sf "$MISE_PROJECT_ROOT/tina-daemon/target/release/tina-daemon" "$BIN_DIR/tina-daemon"
echo "Installed:"
echo "  $BIN_DIR/tina-session"
echo "  $BIN_DIR/tina-monitor"
echo "  $BIN_DIR/tina-daemon"
"""

# --- Test ---

[tasks.test]
description = "Run tests across all crates"
run = """
set -e
echo "Testing tina-session..."
cargo test --manifest-path tina-session/Cargo.toml
echo "Testing tina-data..."
cargo test --manifest-path tina-data/Cargo.toml
echo "Testing tina-daemon..."
cargo test --manifest-path tina-daemon/Cargo.toml
echo "Testing tina-monitor..."
cargo test --manifest-path tina-monitor/Cargo.toml
echo "Testing tina-harness..."
cargo test --manifest-path tina-harness/Cargo.toml
"""

[tasks."test:session"]
description = "Test tina-session only"
run = "cargo test --manifest-path tina-session/Cargo.toml"

[tasks."test:data"]
description = "Test tina-data only"
run = "cargo test --manifest-path tina-data/Cargo.toml"

[tasks."test:daemon"]
description = "Test tina-daemon only"
run = "cargo test --manifest-path tina-daemon/Cargo.toml"

[tasks."test:monitor"]
description = "Test tina-monitor only"
run = "cargo test --manifest-path tina-monitor/Cargo.toml"

[tasks."test:harness"]
description = "Test tina-harness only"
run = "cargo test --manifest-path tina-harness/Cargo.toml"

[tasks."test:skills"]
description = "Run Claude Code skill tests"
run = "./tests/claude-code/run-skill-tests.sh"

# --- Check (fast compile check) ---

[tasks.check]
description = "Cargo check all crates"
run = """
set -e
cargo check --manifest-path tina-session/Cargo.toml
cargo check --manifest-path tina-data/Cargo.toml
cargo check --manifest-path tina-daemon/Cargo.toml
cargo check --manifest-path tina-monitor/Cargo.toml
cargo check --manifest-path tina-harness/Cargo.toml
"""

# --- Harness ---

[tasks.validate]
description = "Validate orchestration state files"
run = "cargo run --manifest-path tina-harness/Cargo.toml -- validate {{arg(name=\"path\")}}"

[tasks."harness:run"]
description = "Run a tina-harness scenario"
run = """
cargo run --manifest-path tina-harness/Cargo.toml -- run \
  --scenarios-dir tina-harness/scenarios \
  --test-project-dir tina-harness/test-project \
  {{arg(name="scenario")}}
"""

# --- Utilities ---

[tasks."analyze:tokens"]
description = "Analyze token usage from a session file"
run = "python3 tests/claude-code/analyze-token-usage.py {{arg(name=\"session_file\")}}"

[tasks."plugin:bundle"]
description = "Build a minimal plugin bundle (skills + hooks + binaries, no build artifacts)"
run = "./scripts/build-plugin-bundle.sh"

[tasks."plugin:install"]
description = "Build plugin bundle, install it, update symlinks, and bounce daemon"
depends = ["plugin:bundle"]
run = "./scripts/plugin-post-install.sh install"

[tasks."plugin:update"]
description = "Build plugin bundle, update it, update symlinks, and bounce daemon"
depends = ["plugin:bundle"]
run = "./scripts/plugin-post-install.sh update"

[tasks."bump:version"]
description = "Set version across all crates"
run = """
set -e
VERSION="{{arg(name=\"version\")}}"
if [ -z "$VERSION" ]; then
  echo "Usage: mise run bump:version <version>"
  echo "Current versions:"
  grep '^version' tina-session/Cargo.toml tina-data/Cargo.toml tina-daemon/Cargo.toml tina-monitor/Cargo.toml tina-harness/Cargo.toml
  exit 1
fi
for manifest in tina-session/Cargo.toml tina-data/Cargo.toml tina-daemon/Cargo.toml tina-monitor/Cargo.toml tina-harness/Cargo.toml; do
  sed -i '' "s/^version = \".*\"/version = \"$VERSION\"/" "$manifest"
  echo "  $manifest -> $VERSION"
done
echo "Done. Run 'mise run check' to verify."
"""
