# Orchestration Validation Phase 3 Implementation Plan

> **For Claude:** Use tina:executing-plans to implement this plan.

**Goal:** Create a plan validator that catches drift between design and plans before execution begins by validating target alignment, scope coverage, estimate plausibility, and ROI.

**Architecture:** A new agent (`agents/plan-validator.md`) is invoked after the planner generates phase plans but before team-lead-init spawns for execution. It reads both the design document and the generated plan file, cross-references plan targets against design priorities, verifies all phases together cover the full design scope, checks that per-phase estimates are mathematically reasonable, and performs ROI sanity checks. The orchestrator (`skills/orchestrate/SKILL.md`) adds a validation gate between planner completion and team-lead spawning.

**Phase context:** Phase 1 added runtime validation (phase reviewer with metrics, orchestrator severity handling). Phase 2 added pre-planning validation (design validator gates before planning). Phase 3 completes the validation framework by adding plan validation (between planning and execution), catching drift before any implementation code is written.

---

### Task 1: Create Plan Validator Agent File

**Files:**
- Create: `/Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/agents/plan-validator.md`

**Step 1: Write the plan validator agent**

Create the new agent file with the following content:

```markdown
---
name: plan-validator
description: |
  Validates generated plans against design documents before execution begins.
  Checks target alignment, scope coverage, estimate plausibility, and ROI.
  Provide: design doc path + plan file path. Returns: validated/rejected with severity tier.
model: inherit
---

You are validating a generated plan against its design document before execution begins.

## Input

You receive:
- Design document path (has Success Metrics section with goal and phase estimates)
- Plan file path (generated by planner for a specific phase)
- Phase number being validated
- Output file path (where to write the validation report)

## Output

Write your validation report to the specified output file. The report MUST include:
1. All validation checks performed
2. A clear **Status:** line with exactly one of: Pass, Warning, Stop
3. A **Severity tier:** line explaining the basis for the status
4. A **Recommendation:** explaining what should happen next

## Your Job

### 1. Check Target Alignment

Cross-reference the plan's target files against the design document's phase estimates.

**Step 1:** Extract target files from design document

Look in the design's `## Success Metrics` section for a Phase estimates table:
```markdown
| Phase | Expected Deliverable | Target Files |
|-------|---------------------|--------------|
| 1 | ... | file1.rs, file2.rs |
```

Also check the phase description in `## Phases` for file mentions.

**Step 2:** Extract target files from plan

Look in the plan's tasks for:
- `**Files:**` sections listing Create/Modify/Test paths
- `**Target files:**` section in Phase Estimates

**Step 3:** Compare targets

```
design_targets = files mentioned in design for this phase
plan_targets = files listed in plan tasks

missing = design_targets - plan_targets  # In design but not in plan
extra = plan_targets - design_targets    # In plan but not in design
```

**Severity:**
- **Stop:** >50% of design targets missing from plan
- **Warning:** Some targets missing OR significant extra files (scope creep)
- **Pass:** Plan targets align with design targets (minor additions OK)

### 2. Check Scope Coverage

Verify the plan covers the deliverables described in the design phase.

**Step 1:** Extract deliverables from design

Look in the design's phase section for:
- Explicit deliverables list
- Scope description
- Expected outcomes

**Step 2:** Extract what plan delivers

Read through plan tasks and identify:
- Components being created/modified
- Capabilities being added
- Tests being written

**Step 3:** Compare coverage

Check that each design deliverable has corresponding plan tasks.

**Severity:**
- **Stop:** Major deliverables missing from plan
- **Warning:** Minor deliverables missing or plan has significant extra scope
- **Pass:** Plan covers all design deliverables

### 3. Check Estimate Plausibility

Verify the plan's estimates are mathematically reasonable.

**Step 1:** Extract estimates from plan

Look in plan's `## Phase Estimates` section for:
- Impl lines expected
- Test lines expected
- Files touched expected
- Any custom metrics

**Step 2:** Count plan steps

Count the number of substantive steps in the plan:
- Implementation steps (writing code)
- Test steps (writing tests)
- Total tasks

**Step 3:** Sanity check

```
lines_per_task = expected_impl_lines / num_impl_tasks
test_lines_per_task = expected_test_lines / num_test_tasks

# Flags
if lines_per_task > 200: Warning (large tasks)
if lines_per_task < 5: Warning (trivial tasks, overhead)
if expected_impl_lines > 500 for single phase: Warning (phase too large)
```

**Severity:**
- **Stop:** Estimates wildly implausible (e.g., 1000 lines in 2 tasks)
- **Warning:** Estimates on edge of plausible (very large or very small)
- **Pass:** Estimates reasonable for the scope

### 4. Check ROI (for applicable work)

If this is test work or coverage work, validate ROI expectations.

**Step 1:** Check if ROI applies

ROI validation applies when:
- Design mentions coverage targets
- Plan's ROI expectation field is populated
- Work is primarily test-related

**Step 2:** Evaluate ROI expectation

```
# For test/coverage work
expected_roi = plan's ROI expectation (e.g., "0.3 coverage lines per test line")
expected_test_lines = from plan estimates
implied_coverage_gain = expected_roi * expected_test_lines
design_goal = from design's Success Metrics

if implied_coverage_gain < design_phase_estimate:
    Warning - ROI too low to meet phase goal
```

**Step 3:** Compare against design threshold

If design specifies ROI threshold in Success Metrics:
```
if plan_roi < design_roi_threshold * 0.5:
    Stop - ROI far below threshold
if plan_roi < design_roi_threshold:
    Warning - ROI below threshold
```

**Severity:**
- **Stop:** ROI < 50% of design threshold
- **Warning:** ROI below threshold but above 50%
- **Pass:** ROI meets or exceeds threshold (or not applicable)

## Severity Tiers

| Severity | Condition | Action |
|----------|-----------|--------|
| Stop | Plans don't cover scope, OR estimates implausible, OR ROI unacceptable | Reject, require replanning |
| Warning | Some drift from priorities, OR marginal ROI, OR estimates on edge | Flag concerns, allow proceed |
| Pass | Plans align with design, estimates plausible, ROI acceptable | Continue to execution |

## Report Format

```markdown
## Plan Validation Report

### Plan Details
**Design doc:** [path]
**Plan file:** [path]
**Phase:** [number]
**Validated at:** [timestamp]

### Target Alignment Check
**Status:** Pass / Warning / Stop

**Design targets for this phase:**
- `file1.rs` - [description from design]
- `file2.rs` - [description from design]

**Plan targets:**
- `file1.rs` - covered in Task N
- `file2.rs` - covered in Task M
- `extra_file.rs` - NOT in design (scope creep?)

**Alignment:**
- Covered: N/M design targets
- Missing: [list any missing]
- Extra: [list any additions]

**Issues:**
- [List specific alignment issues]

### Scope Coverage Check
**Status:** Pass / Warning / Stop

**Design deliverables:**
1. [Deliverable from design]
2. [Another deliverable]

**Plan coverage:**
1. [Deliverable] - Covered by Tasks X, Y
2. [Another] - Covered by Task Z

**Gaps:**
- [Any missing deliverables]

### Estimate Plausibility Check
**Status:** Pass / Warning / Stop

**Plan estimates:**
| Metric | Value | Plausibility |
|--------|-------|--------------|
| Impl lines | ~150 | OK (75 lines/task avg) |
| Test lines | ~200 | OK (50 lines/task avg) |
| Tasks | 5 | OK |

**Flags:**
- [Any implausibility flags]

### ROI Check
**Status:** Pass / Warning / Stop / N/A

**Applicable:** [Yes/No - explain]
**Design ROI threshold:** [value or N/A]
**Plan ROI expectation:** [value or N/A]
**Assessment:** [explanation]

### Summary
**Status:** Pass / Warning / Stop
**Severity tier:** [Worst of all checks]

**Recommendation:**
- **Pass:** Plan validated, proceed to execution
- **Warning:** Plan has concerns noted above, proceed with caution
- **Stop:** Plan must be revised before execution can begin

**If Stop, required changes:**
1. [Specific change needed]
2. [Another change needed]
```

## Critical Rules

**DO:**
- Read both design document and plan file completely
- Cross-reference specific targets (file paths, deliverables)
- Calculate actual ratios for plausibility checks
- Give specific feedback on what's misaligned
- Output clear severity tier

**DON'T:**
- Approve plans that miss major design deliverables
- Skip ROI check for test/coverage work
- Give vague feedback ("needs better alignment") - be specific
- Block plans for minor additions beyond design scope
- Assume plan is correct without checking against design
```

**Step 2: Verify the file was created**

Run: `ls -la /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/agents/plan-validator.md`
Expected: File exists with recent timestamp

Run: `head -20 /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/agents/plan-validator.md`
Expected: Shows the YAML frontmatter and beginning of the agent definition

**Step 3: Commit the new agent**

```bash
cd /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation && git add agents/plan-validator.md && git commit -m "feat: add plan-validator agent for pre-execution validation"
```

---

### Task 2: Add Plan Validator Gate to Orchestrator

**Files:**
- Modify: `/Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/skills/orchestrate/SKILL.md`

**Step 1: Read the orchestrator to find the insertion point**

The orchestrator currently has this flow in the phase loop:
1. Spawn planner subagent (3a)
2. Update supervisor state (3b)
3. Initialize phase directory (3c)
4. Spawn team-lead in tmux (3d)

We need to insert plan validation between planner completion (3a/3b) and team-lead spawning (3d).

**Step 2: Add Plan Validator invocation after planner returns**

Find the section "**3b. Update Supervisor State**" in the orchestrator. After the plan path is saved to state, add a new "**3b-2. Validate Plan**" section.

Locate the text that ends with:
```bash
# Add plan path to state
tmp_file=$(mktemp)
jq ".plan_paths[\"$PHASE_NUM\"] = \"$PLAN_PATH\"" .tina/supervisor-state.json > "$tmp_file" && mv "$tmp_file" .tina/supervisor-state.json
```

After this block, add:

```markdown

**3b-2. Validate Plan**

Before spawning team-lead, validate the plan against the design document.

```bash
echo "Validating plan for phase $PHASE_NUM..."

# Create validation output directory
mkdir -p "$WORKTREE_PATH/.tina/phase-$PHASE_NUM"

# Spawn plan validator
# Task tool parameters:
#   subagent_type: "tina:plan-validator"
#   model: "opus"
#   prompt: |
#     Design doc: $DESIGN_DOC
#     Plan file: $PLAN_PATH
#     Phase: $PHASE_NUM
#     Output file: $WORKTREE_PATH/.tina/phase-$PHASE_NUM/plan-validation.md
#
#     Validate this plan against the design and write your report to the output file.
#     Return ONLY: VALIDATION_STATUS: Pass/Warning/Stop

# Parse validation status
PLAN_VALIDATION_STATUS=$(echo "$VALIDATOR_OUTPUT" | grep "^VALIDATION_STATUS:" | cut -d' ' -f2)

case "$PLAN_VALIDATION_STATUS" in
  "Pass")
    echo "Plan validated successfully for phase $PHASE_NUM"
    ;;

  "Warning")
    echo "Plan validated with warnings for phase $PHASE_NUM - proceeding with caution"
    echo "See: $WORKTREE_PATH/.tina/phase-$PHASE_NUM/plan-validation.md"
    ;;

  "Stop")
    echo "Plan validation FAILED for phase $PHASE_NUM"
    echo ""
    cat "$WORKTREE_PATH/.tina/phase-$PHASE_NUM/plan-validation.md"
    echo ""
    echo "Plan must be revised before execution can proceed."
    echo "Options:"
    echo "1. Re-run planner with additional guidance"
    echo "2. Manually edit the plan file"
    echo "3. Update design document if scope changed"
    exit 1
    ;;

  *)
    echo "Unknown validation status: $PLAN_VALIDATION_STATUS - treating as warning"
    ;;
esac
```
```

**Step 3: Update the process flow diagram**

Find the `digraph orchestrate` diagram in the "## The Process" section. Update it to include the plan validator step.

Find the lines related to the planner and team-lead:
```
"Spawn planner subagent" -> "Wait for plan path";
"Wait for plan path" -> "Spawn team-lead-init in tmux";
```

Replace them with:
```
"Spawn planner subagent" -> "Wait for plan path";
"Wait for plan path" -> "Validate plan (tina:plan-validator)";
"Validate plan (tina:plan-validator)" [shape=box];
"Plan valid?" [shape=diamond];
"Validate plan (tina:plan-validator)" -> "Plan valid?";
"Plan valid?" -> "Spawn team-lead-init in tmux" [label="pass/warning"];
"Plan valid?" -> "Report failure, require replanning" [label="stop"];
"Report failure, require replanning" [shape=box style=filled fillcolor=lightcoral];
```

**Step 4: Update the Integration section**

Find the "## Integration" section. Add the plan validator to the "Spawns" list.

Find the "**Spawns:**" list and add after the design-validator line:
```markdown
- `tina:plan-validator` - Validates plan against design before execution (per phase)
```

**Step 5: Add plan validator to Model Policy table**

Find the "## Model Policy" section with the model table. Add the plan validator after the design validator row.

Find the row for "**Design Validator**" and add after it:
```markdown
| **Plan Validator** | opus | Cross-references plan with design, checks estimates - needs reasoning |
```

**Step 6: Verify changes**

Run: `grep -c "plan-validator" /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/skills/orchestrate/SKILL.md`
Expected: At least 4 occurrences

Run: `grep "Validate plan" /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/skills/orchestrate/SKILL.md`
Expected: Shows the new step in the flow

**Step 7: Commit the change**

```bash
cd /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation && git add skills/orchestrate/SKILL.md && git commit -m "feat: add plan validator gate to orchestrator between planner and team-lead"
```

---

### Task 3: Add Plan Validation State File Documentation

**Files:**
- Modify: `/Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/skills/orchestrate/SKILL.md`

**Step 1: Add plan validation report to state files**

Find the "## State Files" section. After the "**Baseline metrics:**" section (added in Phase 2), add documentation for the plan validation report.

Add:

```markdown

**Plan validation:** `.tina/phase-N/plan-validation.md`

Written by plan validator before execution of each phase. Contains:
- Target alignment analysis (design targets vs plan targets)
- Scope coverage verification (deliverables checked)
- Estimate plausibility assessment
- ROI check (if applicable)
- Final severity tier and recommendation

Used by orchestrator to gate execution. If validation fails (Stop), execution halts and user must revise plan or design.
```

**Step 2: Update phase status file documentation**

Find the "**Phase status:** `.tina/phase-N/status.json`" section. The phase directory now contains both status.json and plan-validation.md. Update the description to mention both files:

Find the existing Phase status section and update it to clarify the directory structure:

```markdown
**Phase directory:** `.tina/phase-N/`

Contains per-phase state files:
- `status.json` - Execution status (pending/executing/complete)
- `plan-validation.md` - Plan validator report (written before execution)
- `review.md` - Phase reviewer report (written after execution)
- `handoff.md` - Context handoff document (for checkpoint/rehydrate)

**Phase status:** `.tina/phase-N/status.json`
```json
{
  "status": "executing",
  "started_at": "2026-01-26T10:00:00Z"
}
```
```

**Step 3: Verify changes**

Run: `grep "plan-validation.md" /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/skills/orchestrate/SKILL.md`
Expected: Multiple occurrences showing documentation and usage

**Step 4: Commit the change**

```bash
cd /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation && git add skills/orchestrate/SKILL.md && git commit -m "docs: add plan validation state file documentation to orchestrator"
```

---

### Task 4: Update Design Document Phase Estimates Table

**Files:**
- Modify: `/Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/docs/plans/2026-01-26-orchestration-validation-design.md`

**Step 1: Verify Phase 3 is already listed in the design**

Read the design document's Success Metrics section to confirm Phase 3 is documented.

Run: `grep -A 5 "Phase 3" /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/docs/plans/2026-01-26-orchestration-validation-design.md`

The design should already have Phase 3 listed in the Phase estimates table with target files: `agents/plan-validator.md, skills/orchestrate/SKILL.md`.

**Step 2: Verify no changes needed**

If the Phase 3 entry exists with correct target files, no changes are needed to the design document.

If the entry is missing or incomplete, add:
```markdown
| 3 | Plan validator agent + orchestrator gate | agents/plan-validator.md, skills/orchestrate/SKILL.md |
```

**Step 3: Report verification**

Run: `grep "plan-validator" /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/docs/plans/2026-01-26-orchestration-validation-design.md`
Expected: Shows plan-validator.md in the Phase estimates table

---

### Task 5: Final Verification

**Step 1: Verify all modified and created files**

Run:
```bash
cd /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation && ls -la agents/plan-validator.md skills/orchestrate/SKILL.md
```

Expected: Both files exist with recent modification times

**Step 2: Verify plan-validator agent content**

Run: `grep -c "Target Alignment" /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/agents/plan-validator.md`
Expected: At least 2 occurrences

Run: `grep -c "Scope Coverage" /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/agents/plan-validator.md`
Expected: At least 2 occurrences

Run: `grep -c "severity" /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/agents/plan-validator.md`
Expected: At least 3 occurrences

**Step 3: Verify orchestrator integration**

Run: `grep -c "plan-validator" /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/skills/orchestrate/SKILL.md`
Expected: At least 5 occurrences

Run: `grep "3b-2" /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/skills/orchestrate/SKILL.md`
Expected: Shows the new validation step number

**Step 4: Verify process flow includes plan validation**

Run: `grep "Plan valid?" /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/skills/orchestrate/SKILL.md`
Expected: Shows the plan validation decision node in the diagram

**Step 5: Verify model policy includes plan validator**

Run: `grep "Plan Validator" /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation/skills/orchestrate/SKILL.md`
Expected: Shows in Model Policy table

**Step 6: Verify git history**

Run: `cd /Users/joshua/Projects/supersonic/.worktrees/orchestration-validation && git log --oneline -5`

Expected commits (most recent first):
- docs: add plan validation state file documentation to orchestrator
- feat: add plan validator gate to orchestrator between planner and team-lead
- feat: add plan-validator agent for pre-execution validation

**Step 7: Report completion**

```
Phase 3 complete!

Files created:
- agents/plan-validator.md - New agent for pre-execution plan validation

Files modified:
- skills/orchestrate/SKILL.md - Added plan validator gate (Step 3b-2), model policy, state file docs

Key capabilities added:
1. Plan validator agent checks target alignment (plan vs design files)
2. Plan validator verifies scope coverage (deliverables mapped to tasks)
3. Plan validator checks estimate plausibility (lines per task, phase size)
4. Plan validator performs ROI sanity check (for test/coverage work)
5. Orchestrator gates on plan validation before spawning team-lead
6. Plan validation report written to .tina/phase-N/plan-validation.md

Validation framework complete:
- Phase 1: Runtime validation (phase reviewer + orchestrator feedback)
- Phase 2: Pre-planning validation (design validator)
- Phase 3: Pre-execution validation (plan validator)

All three validation gates are now in place.
```

---

## Phase Estimates

| Metric | Expected | Measurement Command |
|--------|----------|---------------------|
| Impl lines added | ~200 | `git diff --stat HEAD~3..HEAD -- '*.md' | tail -1` |
| Test lines added | 0 | N/A (documentation/agent definition phase) |
| Files touched | 2 | `git diff --name-only HEAD~3..HEAD | wc -l` |

**Target files:**
- `agents/plan-validator.md` - New agent (create)
- `skills/orchestrate/SKILL.md` - Add validation gate, model policy, state docs

**ROI expectation:** N/A (infrastructure work - ROI measured by catching plan-design drift before wasted implementation effort)
